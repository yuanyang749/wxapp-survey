<!--投票结果页面-->
<view class="page {{!loading?'pageShow':''}}">
  <!-- 骨架屏加载状态 -->
  <view wx:if="{{loading}}" class="skeleton-wrapper">
    <!-- 投票信息骨架屏 -->
    <skeleton type="card" show="{{true}}" rows="{{1}}" animated="{{true}}"></skeleton>

    <!-- 投票选项骨架屏 -->
    <skeleton type="list" show="{{true}}" rows="{{4}}" animated="{{true}}"></skeleton>
  </view>

  <!-- 主要内容 -->
  <scroll-view wx:else scroll-y style="height:100vh" bindscrolltolower="onPullDownRefresh">

    <!-- 错误提示 -->
    <view wx:if="{{showError}}" class="error-toast">
      <text class="error-text">{{errorMessage}}</text>
    </view>

    <!-- 投票信息 -->
    <view class="survey-header">
      <view class="survey-title">{{survey.title}}</view>
      <view class="survey-meta">
        <text class="survey-type">[{{survey.survey_type === 'single_choice' ? '单选' : '多选'}}]</text>
        <text class="survey-status" wx:if="{{isExpired}}">已结束</text>
        <text class="survey-status active" wx:else>进行中</text>
      </view>
      <view wx:if="{{survey.description}}" class="survey-desc">{{survey.description}}</view>

      <!-- 封面图片 -->
      <view wx:if="{{survey.cover_image_url}}" class="survey-cover">
        <image src="{{survey.cover_image_url}}" mode="aspectFill" class="cover-image"></image>
      </view>

      <!-- 统计信息 -->
      <view class="survey-stats">
        <view class="stat-item">
          <text class="stat-number">{{totalVotes}}</text>
          <text class="stat-label">总票数</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{totalParticipants}}</text>
          <text class="stat-label">参与人数</text>
        </view>
      </view>
    </view>
    <!-- 投票选项 -->
    <view class="options-container">
      <!-- 未参与时显示投票界面 -->
      <view wx:if="{{!hasParticipated && canParticipate}}" class="voting-section">
        <view class="section-title">请选择您的选项</view>

        <view class="options-list">
          <block wx:for="{{options}}" wx:key="id" wx:for-item="option">
            <view class="option-item {{userSelections.indexOf(option.id) > -1 ? 'selected' : ''}}"
                  data-option-id="{{option.id}}"
                  bindtap="onOptionSelect">

              <!-- 选择指示器 -->
              <view class="option-indicator">
                <view wx:if="{{survey.survey_type === 'single_choice'}}"
                      class="radio-indicator {{userSelections.indexOf(option.id) > -1 ? 'checked' : ''}}">
                </view>
                <view wx:else
                      class="checkbox-indicator {{userSelections.indexOf(option.id) > -1 ? 'checked' : ''}}">
                  <image wx:if="{{userSelections.indexOf(option.id) > -1}}"
                         src="/images/icon-sq.png"
                         class="check-icon"></image>
                </view>
              </view>

              <!-- 选项内容 -->
              <view class="option-content">
                <text class="option-text">{{option.option_text}}</text>
              </view>
            </view>
          </block>
        </view>

        <!-- 提交按钮 -->
        <view class="submit-section">
          <button class="submit-btn {{submitting ? 'submitting' : ''}}"
                  bindtap="onSubmitVote"
                  disabled="{{submitting || userSelections.length === 0}}">
            <text wx:if="{{submitting}}">提交中...</text>
            <text wx:else>提交投票</text>
          </button>
        </view>
      </view>

      <!-- 无法参与时的提示 -->
      <view wx:elif="{{!canParticipate}}" class="cannot-participate">
        <view class="tip-icon">
          <image src="/images/icon-more.png" class="info-icon"></image>
        </view>
        <view class="tip-content">
          <text wx:if="{{!isAuthenticated}}" class="tip-text">需要授权后才能参与投票</text>
          <text wx:elif="{{hasParticipated}}" class="tip-text">您已经参与过此投票</text>
          <text wx:elif="{{isExpired}}" class="tip-text">投票已结束</text>
          <text wx:else class="tip-text">暂时无法参与此投票</text>
        </view>
        <button wx:if="{{!isAuthenticated}}"
                class="auth-btn"
                bindtap="onAuthorizeTap">
          立即授权
        </button>
      </view>

      <!-- 结果展示 -->
      <view wx:if="{{hasParticipated || showResults}}" class="results-section">
        <view class="section-header">
          <text class="section-title">投票结果</text>
          <button class="toggle-btn" bindtap="onToggleResults">
            {{showResults ? '隐藏结果' : '显示结果'}}
          </button>
        </view>

        <view wx:if="{{showResults}}" class="results-list">
          <block wx:for="{{options}}" wx:key="id" wx:for-item="option">
            <view class="result-item">
              <view class="result-header">
                <text class="result-text">{{option.option_text}}</text>
                <view class="result-stats">
                  <text class="vote-count">{{option.vote_count || 0}}票</text>
                  <text class="vote-percent">{{option.percentage || 0}}%</text>
                </view>
              </view>

              <!-- 进度条 -->
              <view class="progress-container">
                <view class="progress-bar">
                  <view class="progress-fill"
                        style="width: {{option.percentage || 0}}%">
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-section">
      <button class="action-btn secondary" bindtap="onToggleResults">
        {{showResults ? '隐藏结果' : '查看结果'}}
      </button>
      <button class="action-btn primary" bindtap="navigateToCreate">
        创建投票
      </button>
    </view>

  </scroll-view>
</view>